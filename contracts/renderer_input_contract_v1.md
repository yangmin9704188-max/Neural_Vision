# Renderer Input Contract v1 (SSoT)

**목적**: 메인 렌더러가 실제로 읽는 경로/파일명/필드/판정 규칙을 문서로 고정하여 추론을 제거한다.  
**원칙**: FAIL 금지(warn-only). 기존 렌더러 동작을 깨지 않는다(하위호환 유지).

---

## 1. 입력 파일 목록 및 경로 패턴

| 입력 | 경로 패턴 | 용도 | Append-only |
|------|-----------|------|-------------|
| PROGRESS_LOG | `<lab_root>/exports/progress/PROGRESS_LOG.jsonl` | progress event stream | ✅ |
| WORK_BRIEF | `<lab_root>/exports/brief/<MODULE>_WORK_BRIEF.md` | generated by render_work_briefs | ❌ |
| run_registry | `ops/run_registry.jsonl` | ROUND_END에서 추출한 run 레코드 | ✅ |
| master_plan | `contracts/master_plan_v1.json` | SSoT: unlocks, plan_items, artifacts | ❌ |

- **lab_root**: Body = repo root; Fitting = `modules/fitting`; Garment = `modules/garment`. 경로 해석: `ops/lab_roots.local.json`의 `FITTING_LAB_ROOT`/`GARMENT_LAB_ROOT` (또는 환경변수).
- **PROGRESS_LOG**: Body는 `REPO_ROOT/exports/progress/PROGRESS_LOG.jsonl`; Fitting/Garment는 각 lab root 하위.

---

## 2. PROGRESS_LOG event 최소 스키마

### 2.1 필수 필드 (required)

| 필드 | 타입 | 설명 |
|------|------|------|
| `ts` | str | ISO 8601 타임스탬프 (예: `2026-02-08T11:50:00+09:00`) |
| `module` | str | `body` | `fitting` | `garment` |
| `event_type` 또는 `event` | str | 이벤트 유형 (아래 enum 참고) |
| `step_id` | str | 스텝 식별자 (예: B01, F01, G12). 누락 시 `UNSPECIFIED`로 간주됨 |

### 2.2 Optional 필드

| 필드 | 타입 | 설명 |
|------|------|------|
| `round_id` | str | 라운드 ID |
| `lane` | str | run lane |
| `run_id` | str | run ID |
| `evidence_paths` | list[str] | evidence 경로 목록 |
| `evidence` | list[str] | (레거시) evidence 경로 |
| `artifacts_touched` | list[str] | 터치된 아티팩트 경로 |
| `gate_codes` | list[str] 또는 str | 게이트 코드 (예: STEP_ID_BACKFILLED) |
| `gate_code` | str | (레거시) 단일 gate_code |
| `note` | str | 메모 |
| `dod_done_delta` | int | DoD 완료 델타 |
| `dod_total` | int | DoD 총량 |
| `warnings` | list[str] | 경고 메시지 |

---

## 3. Brief 파일명 규칙 (정본)

| 모듈 | 정본 파일명 |
|------|-------------|
| Body | `BODY_WORK_BRIEF.md` |
| Fitting | `FITTING_WORK_BRIEF.md` |
| Garment | `GARMENT_WORK_BRIEF.md` |

**패턴**: `<MODULE>_WORK_BRIEF.md` (MODULE = BODY | FITTING | GARMENT, 대문자).  
허용 범위: 현재 모듈은 body, fitting, garment 3종. 신규 모듈 추가 시 이 문서에 명시하여 확장.

---

## 4. STEP_ID_MISSING 판정 규칙 (코드 기준)

### 4.1 출처

- **STEP_ID_MISSING**: `step_id == "UNSPECIFIED"` 인 이벤트가 발생할 때마다 1건 카운트.
- **집계 범위**: `render_work_briefs`는 전체 이벤트; `render_status` 블로커 집계는 **최근 50줄** (`max_events=50`).

### 4.2 상쇄 규칙

- **STEP_ID_BACKFILLED**: 이벤트의 `gate_codes` 또는 `gate_code`에 `"STEP_ID_BACKFILLED"`가 있거나,  
  `warnings` 배열에 `"STEP_ID_BACKFILLED"`가 포함된 문자열이 있으면 1건 카운트.
- **Net count**: `max(0, UNSPECIFIED_count - STEP_ID_BACKFILLED_count)` 만큼 `STEP_ID_MISSING` 경고를 생성.

### 4.3 코드 참조

- `tools/render_work_briefs.py`: `_aggregate_by_module()` (line ~131-154)
- `tools/render_status.py`: `_aggregate_blockers_top_n()` (max_events=50)

---

## 5. Smoke PASS/UNKNOWN 판정 규칙

- **Smoke**는 `master_plan`의 `done_when` / `unlocks` 논리로만 판정한다.
- **별도 임의 규칙 금지**: `artifact_observed` + m0/m1_checks 기반.
- **PASS 근거**: `artifact_observed`가 `path_glob_any`로 `exports/runs/**` 내 파일 매칭 시 true.
- **UNKNOWN**: master_plan에 정의되지 않은 조건으로 판정하지 않는다.

---

## 6. Repo boundary / SoT 위치

| 역할 | 위치 | 설명 |
|------|------|------|
| 기록 (SoT) | `lab exports/progress/*.jsonl` + `lab exports/runs/**` | 각 lab이 기록하는 progress, run 산출물 |
| 메인 기록 | `exports/progress/PROGRESS_LOG.jsonl`, `ops/run_registry.jsonl` | Body lab + run 레지스트리 |
| 판정/표면화 | `ops/*` | STATUS.md, DASHBOARD.md, hub_state_v1.json 등 |
| 정본 계약 | `contracts/master_plan_v1.json`, `contracts/renderer_input_contract_v1.md` | SSoT |

---

## 7. 검증 도구

- `tools/ops/validate_renderer_inputs.py`: warn-only 입력 검증. exit 0 항상.

---

*Contract version: v1 | Updated: 2026-02-08*

## 9. 재발 방지 규율 (Lab 필수, 0 warnings 목표)

### 9.1 단일 통로 원칙 (MUST)
- Lab은 `exports/progress/PROGRESS_LOG.jsonl`에 이벤트를 기록할 때 **오직 `roundwrap start/end`만 사용한다.**
- 수동으로 JSONL 라인을 append(예: "note" 이벤트 임의 추가)하지 않는다.
- 목표: `py tools/ops/validate_renderer_inputs.py` 실행 시 **새로 추가된 라인에 대해 warning=0**.

### 9.2 이벤트 최소 스키마 (MUST)
모든 신규 이벤트 라인은 다음 필드를 반드시 포함한다:
- `ts` (ISO-8601, timezone 포함 권장)
- `module` ("body" | "fitting" | "garment")
- `step_id` (빈 값 금지)
- `event_type` 또는 `event` (둘 중 하나는 반드시)

> `event_type/event` 누락은 스키마 위반(SCHEMA_VIOLATION)이며 신규 라인에서 발생하면 안 된다.

### 9.3 step_id 누락 방지 (MUST)
- `roundwrap start/end`는 `step_id` 미지정 시 **즉시 실패(exit non-zero)하고 이벤트를 append하지 않는다.**
- 과거에 `step_id == "UNSPECIFIED"` 이벤트가 존재한다면, append-only 원칙으로 `BACKFILL` 이벤트를 추가하고 `gate_codes=["STEP_ID_BACKFILLED"]`로 정리한다.

### 9.4 레거시 스키마 위반 정리 방식 (MUST, append-only)
- 이미 존재하는 레거시 라인(예: `event_type/event` 누락)은 **수정/삭제 금지**.
- 대신 tombstone(INFO) 이벤트를 append하여 종결한다:
  - `event_type="INFO"`
  - `gate_codes`에 `"SCHEMA_VIOLATION_BACKFILLED"` 포함
  - `note`에 `referenced_line=<N>` 포함 (1-indexed)
- 검증기(`validate_renderer_inputs`)는 tombstone의 `referenced_line`을 면책 처리(exempt)할 수 있다.

