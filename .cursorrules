# .cursorrules — AI Fitting Engine (Ops + External Labs) v2
# Last updated: 2026-02-05
#
# PURPOSE
# - Keep Ops automation minimal & safe: observe → summarize → update ops/STATUS.md only via markers.
# - Prevent entropy: no ad-hoc folders, no silent moves, no mixed manual/generated content.
#
# ABSOLUTE RULE:
# If any instruction below conflicts with a local file listed under "Canonical Sources (must read)",
# the local file wins. Otherwise this file is authoritative.

──────────────────────────────────────────────────────────────────────────────
0) Canonical Sources (must read before any work)
──────────────────────────────────────────────────────────────────────────────
MUST read these FIRST (in order), in the Hub (main repo):

1) ops/HUB.md
   - Single entrypoint for ops rules, paths, commands, and boundary.

2) ops/STATUS.md
   - Single status document. Manual 영역 + Generated markers.
   - DO NOT edit generated blocks manually.

3) docs/ops/dashboard_legacy/EXPORT_CONTRACT_v0.md   (reference-only)
   - Defines exports surface: progress log, briefs, cross-folder write boundary.

4) docs/ops/dashboard_legacy/DOD_CLAIM_PROTOCOL_v1.md (reference-only)
   - Evidence-first DoD claim rules. No evidence → no dod_done_delta > 0.

5) docs/ops/dashboard_legacy/PLAN_v0.yaml             (reference-only)
   - Mechanical plan (step IDs, totals, deps). Do not reinterpret semantics.

NOTE:
- Legacy docs are references. Current ops is governed by ops/HUB.md + ops/STATUS.md + tools/* in this repo.

──────────────────────────────────────────────────────────────────────────────
1) Roles & Work Boundaries (Hub vs External Labs)
──────────────────────────────────────────────────────────────────────────────
Definitions:
- Hub = this main repo root (Body/main).
- External Labs = fitting_lab, garment_lab (separate folders; may be non-git).

Standard Operating Mode (default):
- Labs are WRITERS for their own progress logs (append-only).
- Hub is the RENDERER/AGGREGATOR for briefs + STATUS.

Hub MAY:
- Modify hub code/docs only within allowed areas (see §2).
- Read external labs’ exports/progress/** (read-only).
- Write external labs’ exports/brief/** only (generated-only publish surface).
- Update ops/STATUS.md markers via tools/render_status.py (generated-only blocks only).

Hub MUST NOT:
- Write anything into external labs except <lab_root>/exports/brief/**.
- Modify lab code/docs or any non-exports paths.
- Write to external labs’ exports/progress/** in Standard Operating Mode.

Labs MAY:
- Append to their own progress log:
  - <lab_root>/exports/progress/PROGRESS_LOG.jsonl (append-only)
- Optionally run a local run-end hook that calls Hub’s append tool (still writes only to their own progress path).

Labs MUST NOT:
- Edit Hub canonical docs/contracts.
- Hand-edit generated-only briefs.

──────────────────────────────────────────────────────────────────────────────
2) Data / Path Policy (Hub)
──────────────────────────────────────────────────────────────────────────────
Local-only (gitignore; NEVER COMMIT):
- data/**
- exports/**

Canonical commit targets:
- contracts/**, ssot/**, ops/**, tools/**, modules/**

If unsure: do not add to git; ask user.

──────────────────────────────────────────────────────────────────────────────
3) Generated-only Rule (No mixing manual & generated)
──────────────────────────────────────────────────────────────────────────────
A) ops/STATUS.md
- Manual 영역은 사람이 편집.
- Generated 영역은 markers 내부만 도구가 덮어씀.
- Markers:
  - <!-- GENERATED:BEGIN:BODY --> ... <!-- GENERATED:END:BODY -->
  - <!-- GENERATED:BEGIN:FITTING --> ... <!-- GENERATED:END:FITTING -->
  - <!-- GENERATED:BEGIN:GARMENT --> ... <!-- GENERATED:END:GARMENT -->

B) External lab briefs (generated-only)
- <lab_root>/exports/brief/*_WORK_BRIEF.md
- Generated-only. Never hand-edit.

──────────────────────────────────────────────────────────────────────────────
4) Facts-only Rule (No invented judgments)
──────────────────────────────────────────────────────────────────────────────
Across ALL outputs (docs, logs, briefs, scripts):
- Do NOT invent progress.
- Use facts: file exists/missing, counts, timestamps, parse errors, command exit code, schema valid/invalid.
- Warnings are factual reasons (missing file, parse fail, path not set).

Allowed status vocabulary (lightweight):
- OK / WARN / N/A (health-level only)
- done/total/remaining counts (if derived from logs/plan)
- exists/missing, valid/invalid (with validator output if used)

──────────────────────────────────────────────────────────────────────────────
5) External Lab Roots Resolution (Path ambiguity elimination)
──────────────────────────────────────────────────────────────────────────────
Hub resolves lab roots in this priority order:
1) ENV:
   - FITTING_LAB_ROOT
   - GARMENT_LAB_ROOT
2) ops/lab_roots.local.json  (LOCAL ONLY; gitignored)
3) Otherwise N/A (must render warnings, but exit 0)

Also keep:
- ops/lab_roots.local.example.json (committable example)

──────────────────────────────────────────────────────────────────────────────
6) Minimal Ops Automation (Current, authoritative)
──────────────────────────────────────────────────────────────────────────────
Hub render pipeline (authoritative):
1) py tools/render_work_briefs.py
   - Reads <lab_root>/exports/progress/PROGRESS_LOG.jsonl (if exists)
   - Writes <lab_root>/exports/brief/*_WORK_BRIEF.md (generated-only)
2) py tools/render_status.py
   - Updates ops/STATUS.md markers only (atomic write, stable warnings)
   - BODY: latest curated/geo summaries (N/A-safe)
   - FITTING/GARMENT: read brief header/mtime and surface as facts

Progress logging tool (Hub-provided; used by labs/hooks):
- py tools/ops/append_progress_event.py
  - Appends one JSONL event line to <lab_root>/exports/progress/PROGRESS_LOG.jsonl
  - Always exit 0; soft-validate evidence optionally.
  - IMPORTANT: dod_done_delta default 0. Do NOT auto-claim DoD.

──────────────────────────────────────────────────────────────────────────────
7) Evidence-first DoD Strictness (No auto-claim)
──────────────────────────────────────────────────────────────────────────────
- DoD completion events (dod_done_delta > 0) are forbidden unless evidence-backed.
- Evidence rules are defined in docs/ops/dashboard_legacy/DOD_CLAIM_PROTOCOL_v1.md (reference).
- Default automation behavior:
  - Record run_finished / note events with dod_done_delta = 0 only.
  - Escalate to user before implementing any auto-claim.

──────────────────────────────────────────────────────────────────────────────
8) Start/End-of-Work Protocol (Low-prompt operation)
──────────────────────────────────────────────────────────────────────────────
At start of a Hub work session:
- Run:
  py tools/render_work_briefs.py
  py tools/render_status.py

At end of a Hub run (if a run-end hook exists in Hub):
- Ensure it calls:
  py tools/render_work_briefs.py
  py tools/render_status.py
- Never break the run: exit 0 expected, warnings surface in STATUS.

──────────────────────────────────────────────────────────────────────────────
9) Natural-language Triggers (User phrases → required ops actions)
──────────────────────────────────────────────────────────────────────────────
If user says (Korean examples):
- "status 갱신", "운영 업데이트", "브리프 반영", "최신 상태 반영"
Then in Hub:
1) py tools/render_work_briefs.py
2) py tools/render_status.py
3) Show facts-only diff summary (paths changed, warnings count)

If user says:
- "DoD 올려", "마일스톤 통과 기록해"
Then:
- Append progress event (dod_done_delta=0 by default) unless explicit evidence paths are provided.
- If user requests dod_done_delta>0, require evidence paths (soft-validate or stronger) per protocol.

──────────────────────────────────────────────────────────────────────────────
10) Repo Layout (Anti-entropy) — MUST follow before creating files/folders
──────────────────────────────────────────────────────────────────────────────
1) 파일/폴더 생성 전 반드시 ssot/repo_layout_policy_v1.md를 먼저 읽고 준수.
2) contracts/** 및 ssot/**는 정본 중복 금지 (다른 위치에는 포인터만 허용).
3) modules/**/src/** 아래 새 코드 생성 시 해당 폴더 CATALOG.md 확인 + 업데이트 필수.
4) data/**, exports/**는 generated-only (커밋 금지).

END OF RULES
──────────────────────────────────────────────────────────────────────────────
